<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PitchCraftAI - DCF Model Generator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-light: #64748b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
        }

        /* Header */
        header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }

        .badge {
            background: var(--warning);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Main Content */
        main {
            padding: 40px 0;
        }

        /* Steps */
        .steps {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 40px;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 24px;
            font-size: 0.875rem;
            color: var(--text-light);
            transition: all 0.2s;
        }

        .step.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .step.completed {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .step-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.75rem;
        }

        .step.active .step-number,
        .step.completed .step-number {
            background: rgba(255,255,255,0.2);
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        /* Company Selection */
        .company-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .company-card {
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .company-card:hover {
            border-color: var(--primary);
            background: #f0f7ff;
        }

        .company-card.selected {
            border-color: var(--primary);
            background: #dbeafe;
        }

        .company-ticker {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--primary);
        }

        .company-name {
            font-size: 0.8rem;
            color: var(--text);
            margin-top: 2px;
            line-height: 1.3;
        }

        .company-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }

        .company-sector {
            font-size: 0.7rem;
            color: var(--secondary);
            padding: 3px 6px;
            background: var(--bg);
            border-radius: 4px;
        }

        .company-ev {
            font-size: 0.7rem;
            color: var(--success);
            font-weight: 500;
        }

        /* Financials Display */
        .financials-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }

        .financial-item {
            text-align: center;
            padding: 16px;
            background: var(--bg);
            border-radius: 12px;
        }

        .financial-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .financial-label {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Chart placeholder */
        .revenue-chart {
            height: 200px;
            background: linear-gradient(to top, #dbeafe 0%, transparent 100%);
            border-radius: 12px;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            padding: 20px;
            margin-top: 20px;
        }

        .chart-bar {
            background: var(--primary);
            border-radius: 4px 4px 0 0;
            width: 40px;
            min-height: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .chart-bar-label {
            position: absolute;
            bottom: -24px;
            font-size: 0.75rem;
            color: var(--text-light);
        }

        .chart-bar-value {
            position: absolute;
            top: -24px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text);
        }

        /* Assumptions Form */
        .assumptions-section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary);
            display: inline-block;
        }

        .assumptions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .form-group {
            position: relative;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text);
        }

        .form-hint {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 4px;
        }

        .form-input {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .input-suffix {
            position: absolute;
            right: 14px;
            top: 38px;
            color: var(--text-light);
            font-size: 0.875rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-primary:disabled {
            background: var(--secondary);
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--bg);
            color: var(--text);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-lg {
            padding: 16px 32px;
            font-size: 1.125rem;
        }

        /* Actions */
        .actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: var(--text-light);
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Success State */
        .success-card {
            text-align: center;
            padding: 48px;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: #d1fae5;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 2.5rem;
        }

        .success-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .success-subtitle {
            color: var(--text-light);
            margin-bottom: 32px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
            margin: 32px 0;
            padding: 24px;
            background: var(--bg);
            border-radius: 12px;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-pass {
            background: #dcfce7;
            color: #166534;
        }

        .status-warn {
            background: #fef3c7;
            color: #92400e;
        }

        .status-fail {
            background: #fee2e2;
            color: #991b1b;
        }

        .tab-layout {
            display: grid;
            grid-template-columns: 240px 1fr;
            gap: 16px;
        }

        .tab-list {
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
        }

        .tab-list button {
            width: 100%;
            text-align: left;
            padding: 10px 12px;
            border: none;
            border-bottom: 1px solid var(--border);
            background: white;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .tab-list button.active {
            background: #dbeafe;
            color: #1d4ed8;
            font-weight: 600;
        }

        .tab-list button:last-child {
            border-bottom: none;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            z-index: 200;
        }

        .modal {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: min(980px, 100%);
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            background: var(--bg);
        }

        /* Tabs */
        .tab-btn {
            padding: 8px 16px;
            border: 1px solid var(--border);
            background: var(--bg);
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            border-color: var(--primary);
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .tab-content {
            margin-top: 16px;
        }

        /* Spreadsheet */
        .spreadsheet {
            overflow-x: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .spreadsheet table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            font-family: 'SF Mono', 'Consolas', monospace;
        }

        .spreadsheet th,
        .spreadsheet td {
            padding: 10px 14px;
            text-align: right;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        .spreadsheet th {
            background: var(--bg);
            font-weight: 600;
            text-align: center;
            position: sticky;
            top: 0;
        }

        .spreadsheet td:first-child,
        .spreadsheet th:first-child {
            text-align: left;
            font-weight: 500;
            background: #fafafa;
            position: sticky;
            left: 0;
        }

        .spreadsheet tr:hover td {
            background: #f0f7ff;
        }

        .spreadsheet .row-header {
            background: var(--bg) !important;
            font-weight: 600;
            color: var(--primary);
        }

        .spreadsheet .input-cell {
            color: #0000ff;
            background: #fff9e6;
        }

        .spreadsheet .output-cell {
            background: #e8f5e9;
            font-weight: 600;
        }

        .spreadsheet .section-row td {
            background: #2F5496;
            color: white;
            font-weight: 600;
            text-align: left;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .steps {
                flex-wrap: wrap;
            }

            .company-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">P</div>
                    PitchCraftAI
                </div>
                <span class="badge">MVP Demo</span>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <!-- Progress Steps -->
            <div class="steps">
                <div class="step active" id="step1-indicator">
                    <span class="step-number">1</span>
                    Select Company
                </div>
                <div class="step" id="step2-indicator">
                    <span class="step-number">2</span>
                    Review Data
                </div>
                <div class="step" id="step3-indicator">
                    <span class="step-number">3</span>
                    Set Assumptions
                </div>
                <div class="step" id="step4-indicator">
                    <span class="step-number">4</span>
                    Generate Model
                </div>
            </div>

            <!-- Step 1: Company Selection -->
            <div id="step1" class="step-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Select Target Company</h2>
                    </div>
                    <div class="company-grid" id="company-grid">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Or Enter NASDAQ Ticker</h2>
                    </div>
                    <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
                        <input id="custom-ticker" class="form-input" style="max-width:240px;" placeholder="e.g., AAPL" />
                        <button class="btn btn-primary" onclick="useCustomTicker()">Use Custom Ticker</button>
                        <span style="color: var(--text-light); font-size: 0.875rem;">NASDAQ only</span>
                    </div>
                </div>
            </div>

            <!-- Step 2: Data Review -->
            <div id="step2" class="step-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span id="company-display-name">Company</span> - Financial Overview
                        </h2>
                        <span class="badge" style="background: var(--success);">Live SEC Data</span>
                    </div>

                    <div id="loading-data" class="loading">
                        <div class="spinner"></div>
                        <p>Fetching live data from SEC EDGAR...</p>
                    </div>

                    <div id="financials-display" class="hidden">
                        <div class="financials-grid" id="financials-grid">
                            <!-- Populated by JS -->
                        </div>

                        <div class="revenue-chart" id="revenue-chart">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <div class="actions">
                        <button class="btn btn-secondary" onclick="goToStep(1)">Back</button>
                        <button class="btn btn-primary" onclick="goToStep(3)" id="continue-to-assumptions">
                            Continue to Assumptions
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 3: Assumptions -->
            <div id="step3" class="step-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">DCF Assumptions</h2>
                        <span style="color: var(--text-light); font-size: 0.875rem;">
                            Pre-filled with intelligent defaults based on company data
                        </span>
                    </div>

                    <p style="color: var(--text-light);">
                        Open the assumptions modal to review and confirm inputs with the associate.
                    </p>

                    <div class="actions">
                        <button class="btn btn-secondary" onclick="goToStep(2)">Back</button>
                        <button class="btn btn-primary btn-lg" onclick="openAssumptionsModal()">
                            Open Assumptions Modal
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 4: Success -->
            <div id="step4" class="step-content hidden">
                <!-- Generating State -->
                <div id="generating-state" class="card">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Generating your DCF model...</p>
                    </div>
                </div>

                <!-- Success State -->
                <div id="success-state" class="hidden">
                    <!-- Hero Stats -->
                    <div class="card" style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; border: none;">
                        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 24px;">
                            <div>
                                <div style="font-size: 0.875rem; opacity: 0.8; margin-bottom: 4px;">Model Generated</div>
                                <div style="font-size: 2rem; font-weight: 700;" id="company-result-name">Company DCF</div>
                            </div>
                            <div style="display: flex; gap: 32px; text-align: center;">
                                <div>
                                    <div style="font-size: 2.5rem; font-weight: 700;" id="time-taken">0.8s</div>
                                    <div style="font-size: 0.75rem; opacity: 0.8;">Generation Time</div>
                                </div>
                                <div style="font-size: 1.5rem; opacity: 0.5;">vs</div>
                                <div>
                                    <div style="font-size: 2.5rem; font-weight: 700;">~2.5 hrs</div>
                                    <div style="font-size: 0.75rem; opacity: 0.8;">Manual Build</div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.75rem; opacity: 0.8; margin-bottom: 8px;" id="model-stats">4 Tabs â€¢ 127 Formulas</div>
                                <a id="download-link" class="btn" href="#" download style="background: white; color: #1e40af;">
                                    Download Excel
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Valuation Output -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Valuation Output</h2>
                            <span style="color: var(--success); font-weight: 600;">Live Calculation</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                            <!-- Gordon Growth -->
                            <div style="background: var(--bg); border-radius: 12px; padding: 24px;">
                                <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-light); letter-spacing: 0.5px; margin-bottom: 16px;">Gordon Growth Method</div>
                                <div style="display: grid; gap: 12px;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: var(--text-light);">Enterprise Value</span>
                                        <span style="font-weight: 600;" id="ev-gordon">$0M</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: var(--text-light);">Less: Net Debt</span>
                                        <span style="font-weight: 600;" id="net-debt-gordon">($0M)</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: var(--text-light);">Equity Value</span>
                                        <span style="font-weight: 600;" id="equity-gordon">$0M</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: var(--text-light);">Diluted Shares</span>
                                        <span style="font-weight: 500;" id="diluted-shares">0M</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding-top: 12px; border-top: 2px solid var(--primary);">
                                        <span style="font-weight: 600;">Implied Share Price</span>
                                        <span style="font-size: 1.5rem; font-weight: 700; color: var(--primary);" id="price-gordon">$0.00</span>
                                    </div>
                                </div>
                            </div>
                            <!-- Exit Multiple -->
                            <div style="background: var(--bg); border-radius: 12px; padding: 24px;">
                                <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-light); letter-spacing: 0.5px; margin-bottom: 16px;">Exit Multiple Method</div>
                                <div style="display: grid; gap: 12px;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: var(--text-light);">Enterprise Value</span>
                                        <span style="font-weight: 600;" id="ev-exit">$0M</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: var(--text-light);">Less: Net Debt</span>
                                        <span style="font-weight: 600;" id="net-debt-exit">($0M)</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: var(--text-light);">Equity Value</span>
                                        <span style="font-weight: 600;" id="equity-exit">$0M</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding-top: 12px; border-top: 2px solid var(--success);">
                                        <span style="font-weight: 600;">Implied Share Price</span>
                                        <span style="font-size: 1.5rem; font-weight: 700; color: var(--success);" id="price-exit">$0.00</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Implied Multiples Cross-Check -->
                        <div style="margin-top: 20px; padding: 16px; background: #fef3c7; border-radius: 8px; border: 1px solid #fcd34d;">
                            <div style="font-size: 0.75rem; text-transform: uppercase; color: #92400e; letter-spacing: 0.5px; margin-bottom: 8px;">Implied Multiples (Sanity Check)</div>
                            <div style="display: flex; gap: 32px;">
                                <div>
                                    <span style="color: #92400e;">Implied EV/EBITDA:</span>
                                    <span style="font-weight: 700; color: #78350f;" id="implied-ev-ebitda">0.0x</span>
                                </div>
                                <div>
                                    <span style="color: #92400e;">Implied EV/Revenue:</span>
                                    <span style="font-weight: 700; color: #78350f;" id="implied-ev-revenue">0.0x</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- VP Validation -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">VP Validation Checklist</h2>
                            <span id="vp-review-status" class="status-pill status-warn">NEEDS REVIEW</span>
                        </div>
                        <div id="validation-list" style="display: grid; gap: 12px;">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Model Tabs Preview -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Model Tabs (In-UI Preview)</h2>
                            <span style="color: var(--text-light); font-size: 0.875rem;">30-tab structure with live-linked sections</span>
                        </div>
                        <div class="tab-layout">
                            <div class="tab-list" id="model-tab-list">
                                <!-- Populated by JS -->
                            </div>
                            <div id="model-tab-content">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- In-Browser Spreadsheet View -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">DCF Model Preview</h2>
                            <div style="display: flex; gap: 8px;">
                                <button class="tab-btn active" onclick="showTab('projections')">Projections</button>
                                <button class="tab-btn" onclick="showTab('wacc')">WACC Buildup</button>
                                <button class="tab-btn" onclick="showTab('assumptions')">Key Inputs</button>
                            </div>
                        </div>

                        <!-- Projections Tab -->
                        <div id="tab-projections" class="tab-content">
                            <div class="spreadsheet" id="projections-sheet">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <!-- Assumptions Tab -->
                        <div id="tab-assumptions" class="tab-content hidden">
                            <div class="spreadsheet" id="assumptions-sheet">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <!-- WACC Buildup Tab -->
                        <div id="tab-wacc" class="tab-content hidden">
                            <div class="spreadsheet" id="wacc-sheet">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Next Steps -->
                    <div class="card" style="background: #fefce8; border-color: #fde047;">
                        <div style="display: flex; align-items: flex-start; gap: 16px;">
                            <div style="font-size: 1.5rem;">ðŸ’¡</div>
                            <div>
                                <div style="font-weight: 600; margin-bottom: 8px;">Next Steps</div>
                                <ol style="margin: 0; padding-left: 20px; color: var(--text-light);">
                                    <li>Download the Excel model using the button above</li>
                                    <li>Open in Excel - all cells contain live formulas</li>
                                    <li>Adjust any assumptions in the yellow cells</li>
                                    <li>The entire model recalculates automatically</li>
                                    <li>Copy relevant outputs to your pitch deck</li>
                                </ol>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div style="display: flex; gap: 12px; justify-content: center; margin-top: 24px;">
                        <button class="btn btn-secondary btn-lg" onclick="goToStep(3)">
                            Adjust Assumptions
                        </button>
                        <button class="btn btn-primary btn-lg" onclick="startOver()">
                            New Model
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Assumptions Modal -->
    <div id="assumptions-modal" class="modal-overlay hidden">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="assumptions-modal-title">
            <div class="modal-header">
                <div>
                    <div style="font-size: 0.75rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px;">Assumptions Review</div>
                    <h2 id="assumptions-modal-title" class="card-title">Confirm DCF Assumptions</h2>
                </div>
                <button class="btn btn-secondary" onclick="closeAssumptionsModal()">Close</button>
            </div>
            <div class="modal-body">
                <form id="assumptions-form">
                    <div id="assumptions-container">
                        <!-- Populated by JS with dynamic categories -->
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAssumptionsModal()">Cancel</button>
                <button class="btn btn-primary btn-lg" onclick="generateModel()" id="generate-btn">
                    Generate DCF Model
                </button>
            </div>
        </div>
    </div>

    <script>
        // State
        let companies = [];
        let selectedTicker = null;
        let companyData = null;
        let currentStep = 1;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadCompanies();
        });

        // Load company list
        async function loadCompanies() {
            try {
                const response = await fetch('/api/companies');
                const data = await response.json();
                companies = data.companies;
                renderCompanyGrid();
            } catch (error) {
                console.error('Failed to load companies:', error);
            }
        }

        // Render company selection grid
        function renderCompanyGrid() {
            const grid = document.getElementById('company-grid');
            grid.innerHTML = companies.map(c => `
                <div class="company-card" onclick="selectCompany('${c.ticker}')" id="company-${c.ticker}">
                    <div class="company-ticker">${c.ticker}</div>
                    <div class="company-name">${c.name}</div>
                    <div class="company-meta">
                        <span class="company-sector">${c.sector}</span>
                        ${c.ev_range ? `<span class="company-ev">${c.ev_range}</span>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Select a company
        async function selectCompany(ticker) {
            // Update UI
            document.querySelectorAll('.company-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById(`company-${ticker}`).classList.add('selected');

            selectedTicker = ticker;
            const company = companies.find(c => c.ticker === ticker);
            document.getElementById('company-display-name').textContent = `${company.name} (${ticker})`;

            // Move to step 2
            goToStep(2);

            // Fetch data
            await fetchCompanyData(ticker);
        }

        async function useCustomTicker() {
            const input = document.getElementById('custom-ticker');
            const ticker = (input.value || '').trim().toUpperCase();
            if (!ticker) {
                alert('Enter a NASDAQ ticker (e.g., AAPL).');
                return;
            }
            if (!/^[A-Z]{1,5}$/.test(ticker)) {
                alert('Ticker must be 1â€“5 letters (NASDAQ).');
                return;
            }

            document.querySelectorAll('.company-card').forEach(card => {
                card.classList.remove('selected');
            });

            selectedTicker = ticker;
            document.getElementById('company-display-name').textContent = `Custom Ticker (${ticker})`;
            goToStep(2);
            await fetchCompanyData(ticker);
        }

        // Fetch company data from API
        async function fetchCompanyData(ticker) {
            document.getElementById('loading-data').classList.remove('hidden');
            document.getElementById('financials-display').classList.add('hidden');

            try {
                const response = await fetch(`/api/company/${ticker}`);
                if (!response.ok) throw new Error('Failed to fetch');

                companyData = await response.json();
                renderFinancials();
                renderAssumptionsForm();

                document.getElementById('loading-data').classList.add('hidden');
                document.getElementById('financials-display').classList.remove('hidden');
            } catch (error) {
                console.error('Failed to fetch company data:', error);
                alert('Failed to fetch company data. Please try again.');
                goToStep(1);
            }
        }

        // Render financials display
        function renderFinancials() {
            const fin = companyData.financials;

            // Key metrics
            const metricsHtml = `
                <div class="financial-item">
                    <div class="financial-value">$${formatNumber(fin.revenue[fin.revenue.length - 1])}M</div>
                    <div class="financial-label">LTM Revenue</div>
                </div>
                <div class="financial-item">
                    <div class="financial-value">${(fin.ebitda_margin * 100).toFixed(1)}%</div>
                    <div class="financial-label">EBITDA Margin</div>
                </div>
                <div class="financial-item">
                    <div class="financial-value">${(avgGrowth(fin.revenue_growth) * 100).toFixed(1)}%</div>
                    <div class="financial-label">Avg Growth</div>
                </div>
                <div class="financial-item">
                    <div class="financial-value">$${formatNumber(fin.net_debt)}M</div>
                    <div class="financial-label">Net Debt</div>
                </div>
                <div class="financial-item">
                    <div class="financial-value">${formatNumber(fin.shares_outstanding)}M</div>
                    <div class="financial-label">Shares Out</div>
                </div>
            `;
            document.getElementById('financials-grid').innerHTML = metricsHtml;

            // Revenue chart
            const maxRev = Math.max(...fin.revenue);
            const chartHtml = fin.revenue.map((rev, i) => {
                const height = (rev / maxRev) * 150;
                return `
                    <div class="chart-bar" style="height: ${height}px;">
                        <span class="chart-bar-value">$${formatNumber(rev)}M</span>
                        <span class="chart-bar-label">${fin.revenue_years[i]}</span>
                    </div>
                `;
            }).join('');
            document.getElementById('revenue-chart').innerHTML = chartHtml;
        }

        // Render assumptions form - dynamic categories
        function renderAssumptionsForm() {
            const questions = companyData.questions;
            const container = document.getElementById('assumptions-container');

            // Group questions by category
            const grouped = {};
            questions.forEach(q => {
                if (!grouped[q.category]) {
                    grouped[q.category] = [];
                }
                grouped[q.category].push(q);
            });

            // Render each category
            let html = '';
            for (const [category, qs] of Object.entries(grouped)) {
                html += `
                    <div class="assumptions-section">
                        <h3 class="section-title">${category}</h3>
                        <div class="assumptions-grid">
                `;

                qs.forEach(q => {
                    const isPercent = q.value_type === 'percent';
                    const isMultiple = q.value_type === 'multiple';
                    let displayValue;

                    if (isPercent) {
                        displayValue = (q.default_value * 100).toFixed(1);
                    } else if (isMultiple) {
                        displayValue = q.default_value.toFixed(1);
                    } else if (q.value_type === 'currency') {
                        displayValue = q.default_value.toFixed(0);
                    } else {
                        displayValue = q.default_value.toFixed(q.default_value < 10 ? 2 : 0);
                    }

                    let suffix = '';
                    if (isPercent) suffix = '%';
                    else if (isMultiple) suffix = 'x';
                    else if (q.value_type === 'currency') suffix = '$M';

                    html += `
                        <div class="form-group">
                            <label class="form-label" for="${q.id}">${q.question}</label>
                            <input
                                type="number"
                                class="form-input"
                                id="${q.id}"
                                name="${q.id}"
                                value="${displayValue}"
                                step="${isPercent ? '0.1' : isMultiple ? '0.1' : '1'}"
                                data-type="${q.value_type}"
                            >
                            ${suffix ? `<span class="input-suffix">${suffix}</span>` : ''}
                            <p class="form-hint">${q.hint}</p>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // Generate model
        async function generateModel() {
            closeAssumptionsModal();
            goToStep(4);
            document.getElementById('generating-state').classList.remove('hidden');
            document.getElementById('success-state').classList.add('hidden');

            // Collect form values
            const form = document.getElementById('assumptions-form');
            const formData = new FormData(form);
            const assumptions = {};

            for (const [key, value] of formData.entries()) {
                const input = document.getElementById(key);
                const type = input.dataset.type;
                let numValue = parseFloat(value);

                if (type === 'percent') {
                    numValue = numValue / 100;
                }
                assumptions[key] = numValue;
            }

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ticker: selectedTicker,
                        assumptions: assumptions
                    })
                });

                if (!response.ok) throw new Error('Generation failed');

                const result = await response.json();

                // Show success
                document.getElementById('generating-state').classList.add('hidden');
                document.getElementById('success-state').classList.remove('hidden');

                // Update header stats
                document.getElementById('company-result-name').textContent = `${result.summary.company} (${result.summary.ticker}) DCF Model`;
                document.getElementById('time-taken').textContent = `${result.generation_time_seconds}s`;
                document.getElementById('model-stats').textContent = `${result.model_stats.tabs} Tabs â€¢ ${result.model_stats.formulas} Formulas`;
                document.getElementById('download-link').href = result.download_url;

                // Update valuation output
                const val = result.valuation;
                document.getElementById('ev-gordon').textContent = `$${formatLargeNumber(val.ev_gordon)}`;
                document.getElementById('net-debt-gordon').textContent = `($${formatLargeNumber(val.net_debt)})`;
                document.getElementById('equity-gordon').textContent = `$${formatLargeNumber(val.equity_gordon)}`;
                document.getElementById('diluted-shares').textContent = `${val.diluted_shares.toFixed(1)}M`;
                document.getElementById('price-gordon').textContent = `$${val.price_gordon.toFixed(2)}`;

                document.getElementById('ev-exit').textContent = `$${formatLargeNumber(val.ev_exit)}`;
                document.getElementById('net-debt-exit').textContent = `($${formatLargeNumber(val.net_debt)})`;
                document.getElementById('equity-exit').textContent = `$${formatLargeNumber(val.equity_exit)}`;
                document.getElementById('price-exit').textContent = `$${val.price_exit.toFixed(2)}`;

                // Implied multiples
                document.getElementById('implied-ev-ebitda').textContent = `${val.implied_ev_ebitda.toFixed(1)}x`;
                document.getElementById('implied-ev-revenue').textContent = `${val.implied_ev_revenue.toFixed(1)}x`;

                // Render projections spreadsheet
                renderProjectionsSheet(result);

                // Render assumptions spreadsheet
                renderAssumptionsSheet(result);

                // Render WACC buildup
                renderWaccSheet(result);

                // Render VP validations
                renderValidations(result);

                // Render model tabs
                renderModelTabs(result);

            } catch (error) {
                console.error('Generation failed:', error);
                alert('Failed to generate model. Please try again.');
                goToStep(3);
            }
        }

        // Render projections spreadsheet
        function renderProjectionsSheet(result) {
            const proj = result.projections;
            const years = proj.years;

            let html = `<table>
                <thead>
                    <tr>
                        <th>Line Item</th>
                        ${years.map(y => `<th>${y}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
                    <tr class="section-row"><td colspan="${years.length + 1}">Financial Projections</td></tr>
                    <tr>
                        <td class="row-header">Revenue Growth</td>
                        ${result.assumptions_used.revenue_growth.map((g, i) =>
                            `<td class="${i > 0 ? 'input-cell' : ''}">${i === 0 ? 'â€”' : (g * 100).toFixed(1) + '%'}</td>`
                        ).join('')}
                    </tr>
                    <tr>
                        <td class="row-header">Revenue</td>
                        ${proj.revenue.map(r => `<td>$${formatLargeNumber(r)}</td>`).join('')}
                    </tr>
                    <tr>
                        <td class="row-header">EBITDA</td>
                        ${proj.ebitda.map(e => `<td>$${formatLargeNumber(e)}</td>`).join('')}
                    </tr>
                    <tr>
                        <td class="row-header">Unlevered FCF</td>
                        ${proj.fcf.map(f => `<td>$${formatLargeNumber(f)}</td>`).join('')}
                    </tr>
                    <tr class="section-row"><td colspan="${years.length + 1}">Present Value</td></tr>
                    <tr>
                        <td class="row-header">PV of FCF</td>
                        ${proj.pv_fcf.map((pv, i) => `<td class="${i > 0 ? 'output-cell' : ''}">${i === 0 ? 'â€”' : '$' + formatLargeNumber(pv)}</td>`).join('')}
                    </tr>
                </tbody>
            </table>`;

            document.getElementById('projections-sheet').innerHTML = html;
        }

        // Render assumptions spreadsheet
        function renderAssumptionsSheet(result) {
            const a = result.assumptions_used;
            const s = result.summary;

            let html = `<table>
                <thead>
                    <tr>
                        <th>Assumption</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="section-row"><td colspan="2">Operating Assumptions</td></tr>
                    <tr><td>Base Revenue</td><td class="input-cell">$${formatLargeNumber(s.base_revenue)}</td></tr>
                    <tr><td>EBITDA Margin</td><td class="input-cell">${(a.ebitda_margin * 100).toFixed(1)}%</td></tr>
                    <tr class="section-row"><td colspan="2">WACC</td></tr>
                    <tr><td>Weighted Average Cost of Capital</td><td class="input-cell">${(a.wacc * 100).toFixed(2)}%</td></tr>
                    <tr class="section-row"><td colspan="2">Terminal Value</td></tr>
                    <tr><td>Perpetuity Growth Rate</td><td class="input-cell">${(a.terminal_growth * 100).toFixed(2)}%</td></tr>
                    <tr><td>Exit EV/EBITDA Multiple</td><td class="input-cell">${a.exit_multiple.toFixed(1)}x</td></tr>
                    <tr class="section-row"><td colspan="2">Capital Structure</td></tr>
                    <tr><td>Net Debt</td><td class="input-cell">$${formatLargeNumber(a.net_debt)}</td></tr>
                    <tr><td>Shares Outstanding</td><td class="input-cell">${a.shares_outstanding.toFixed(1)}M</td></tr>
                </tbody>
            </table>`;

            document.getElementById('assumptions-sheet').innerHTML = html;
        }

        // Render WACC buildup spreadsheet
        function renderWaccSheet(result) {
            const w = result.wacc_buildup;

            let html = `<table>
                <thead>
                    <tr>
                        <th>WACC Component</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="section-row"><td colspan="2">Cost of Equity (CAPM + Adjustments)</td></tr>
                    <tr><td>Risk-Free Rate (10Y UST)</td><td class="input-cell">${(w.risk_free_rate * 100).toFixed(2)}%</td></tr>
                    <tr><td>Unlevered Beta</td><td class="input-cell">${w.unlevered_beta.toFixed(2)}</td></tr>
                    <tr><td>Relevered Beta</td><td>${w.levered_beta.toFixed(2)}</td></tr>
                    <tr><td>Equity Risk Premium</td><td class="input-cell">${(w.equity_risk_premium * 100).toFixed(2)}%</td></tr>
                    <tr><td>Size Premium</td><td class="input-cell">${(w.size_premium * 100).toFixed(2)}%</td></tr>
                    <tr><td>Company-Specific Risk</td><td class="input-cell">${(w.company_specific_risk * 100).toFixed(2)}%</td></tr>
                    <tr><td><strong>Cost of Equity</strong></td><td class="output-cell"><strong>${(w.cost_of_equity * 100).toFixed(2)}%</strong></td></tr>

                    <tr class="section-row"><td colspan="2">Cost of Debt</td></tr>
                    <tr><td>Pre-Tax Cost of Debt</td><td class="input-cell">${(w.pre_tax_cost_of_debt * 100).toFixed(2)}%</td></tr>
                    <tr><td>After-Tax Cost of Debt</td><td>${(w.after_tax_cost_of_debt * 100).toFixed(2)}%</td></tr>

                    <tr class="section-row"><td colspan="2">WACC Calculation</td></tr>
                    <tr><td>Equity Weight</td><td>${(w.equity_weight * 100).toFixed(1)}%</td></tr>
                    <tr><td>Debt Weight</td><td>${(w.debt_weight * 100).toFixed(1)}%</td></tr>
                    <tr><td><strong>WACC</strong></td><td class="output-cell"><strong>${(w.wacc * 100).toFixed(2)}%</strong></td></tr>
                </tbody>
            </table>`;

            document.getElementById('wacc-sheet').innerHTML = html;
        }

        function renderValidations(result) {
            const list = document.getElementById('validation-list');
            const vp = document.getElementById('vp-review-status');

            vp.textContent = result.vp_review.status;
            vp.className = `status-pill ${result.vp_review.status === 'PASS' ? 'status-pass' : 'status-warn'}`;

            list.innerHTML = result.validations.map(v => {
                const cls = v.status === 'pass' ? 'status-pass' : v.status === 'fail' ? 'status-fail' : 'status-warn';
                const label = v.status.toUpperCase();
                return `
                    <div style="display:flex; justify-content: space-between; align-items:center; border:1px solid var(--border); padding:12px; border-radius:10px; background: #fafafa;">
                        <div>
                            <div style="font-weight:600;">${v.name}</div>
                            <div style="font-size:0.8rem; color: var(--text-light);">${v.detail}</div>
                        </div>
                        <span class="status-pill ${cls}">${label}</span>
                    </div>
                `;
            }).join('');
        }

        function renderModelTabs(result) {
            const tabs = result.tabs && result.tabs.length ? result.tabs : [
                "Cover",
                "Contents",
                "Inputs_Index",
                "Key_Assumptions",
                "Historical_IS",
                "Historical_BS",
                "Historical_CF",
                "Revenue_Build",
                "COGS_Gross_Margin",
                "Opex",
                "EBITDA_Bridge",
                "D&A",
                "Capex",
                "Working_Capital",
                "Other_Operating",
                "Taxes",
                "Unlevered_FCF",
                "Debt_Schedule",
                "Interest_Expense",
                "Share_Count",
                "WACC",
                "DCF_Valuation",
                "Terminal_Value",
                "EV_Equity_Bridge",
                "Sensitivity",
                "Scenario_Manager",
                "KPI_Dashboard",
                "Trading_Comps",
                "Transactions_Comps",
                "Charts_Checks",
            ];

            const list = document.getElementById('model-tab-list');
            list.innerHTML = tabs.map((t, i) => `
                <button class="${i === 0 ? 'active' : ''}" onclick="showModelTab('${t.replace(/\\s/g, '_')}')">${t}</button>
            `).join('');

            if (result.tabs_missing && result.tabs_missing.length) {
                const warning = document.createElement('div');
                warning.style.padding = '10px 12px';
                warning.style.borderTop = '1px solid var(--border)';
                warning.style.background = '#fef3c7';
                warning.style.color = '#92400e';
                warning.style.fontSize = '0.8rem';
                warning.textContent = `Missing tabs in Excel: ${result.tabs_missing.join(', ')}`;
                list.appendChild(warning);
            }

            window.__modelTabData = buildTabData(result);
            showModelTab(tabs[0]);
        }

        function showModelTab(tabName) {
            const buttons = document.querySelectorAll('#model-tab-list button');
            buttons.forEach(btn => {
                btn.classList.toggle('active', btn.textContent === tabName);
            });
            const content = document.getElementById('model-tab-content');
            const data = window.__modelTabData[tabName] || { title: tabName, table: "<p>No data.</p>" };
            content.innerHTML = `
                <div class="card" style="margin:0; box-shadow:none;">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
                        <div style="font-weight:600;">${data.title}</div>
                        ${data.note ? `<div style="font-size:0.8rem; color: var(--text-light);">${data.note}</div>` : ''}
                    </div>
                    ${data.table}
                </div>
            `;
        }

        function buildTabData(result) {
            const fin = companyData?.financials || {};
            const years = fin.revenue_years || [];
            const revenue = fin.revenue || [];
            const ebitda = fin.ebitda || [];

            const a = result.assumptions_used;
            const s = result.summary;
            const proj = result.projections;

            const pct = (val, digits = 1) => {
                if (val === undefined || val === null || Number.isNaN(val)) return "N/A";
                return (val * 100).toFixed(digits) + "%";
            };

            const table = (headers, rows) => {
                return `
                    <div class="spreadsheet">
                        <table>
                            <thead>
                                <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                            </thead>
                            <tbody>
                                ${rows.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            };

            return {
                "Cover": {
                    title: "Cover",
                    note: "Generated from company selection",
                    table: table(["Field", "Value"], [
                        ["Company", `${s.company} (${s.ticker})`],
                        ["As of", "February 3, 2026"],
                        ["Model", "DCF Valuation Model"],
                    ])
                },
                "Contents": {
                    title: "Contents",
                    table: table(["Tab", "Purpose"], [
                        ["Inputs_Index", "Key inputs and controls"],
                        ["Key_Assumptions", "Core model assumptions"],
                        ["Revenue_Build", "Revenue forecast build"],
                        ["Unlevered_FCF", "Free cash flow"],
                        ["DCF_Valuation", "Valuation summary"],
                        ["Sensitivity", "Sensitivity tables"],
                    ])
                },
                "Inputs_Index": {
                    title: "Inputs Index",
                    table: table(["Input", "Value"], [
                        ["Base Revenue ($M)", `$${formatLargeNumber(s.base_revenue)}`],
                        ["EBITDA Margin", `${(a.ebitda_margin * 100).toFixed(1)}%`],
                        ["Tax Rate", pct(companyData?.defaults?.tax_rate)],
                        ["WACC", `${(a.wacc * 100).toFixed(2)}%`],
                        ["Terminal Growth", `${(a.terminal_growth * 100).toFixed(2)}%`],
                    ])
                },
                "Key_Assumptions": {
                    title: "Key Assumptions",
                    table: table(["Assumption", "Value"], [
                        ["Base Revenue ($M)", `$${formatLargeNumber(s.base_revenue)}`],
                        ["Revenue Growth (Y1â€“Y5)", a.revenue_growth.map(g => (g * 100).toFixed(1) + "%").slice(1).join(", ")],
                        ["EBITDA Margin", `${(a.ebitda_margin * 100).toFixed(1)}%`],
                        ["WACC", `${(a.wacc * 100).toFixed(2)}%`],
                        ["Terminal Growth", `${(a.terminal_growth * 100).toFixed(2)}%`],
                        ["Exit EV/EBITDA", `${a.exit_multiple.toFixed(1)}x`],
                    ])
                },
                "Historical_IS": {
                    title: "Historical Income Statement",
                    note: "SEC-reported revenue and EBITDA",
                    table: table(["Year", "Revenue ($M)", "EBITDA ($M)"], years.map((y, i) => [
                        y,
                        revenue[i] !== undefined ? `$${formatLargeNumber(revenue[i])}` : "N/A",
                        ebitda[i] !== undefined ? `$${formatLargeNumber(ebitda[i])}` : "N/A",
                    ]))
                },
                "Historical_BS": {
                    title: "Historical Balance Sheet (Latest)",
                    note: "Latest SEC snapshot",
                    table: table(["Item", "Value"], [
                        ["Cash ($M)", `$${formatLargeNumber(fin.cash ?? 0)}`],
                        ["Total Debt ($M)", `$${formatLargeNumber(fin.total_debt ?? 0)}`],
                        ["Net Debt ($M)", `$${formatLargeNumber((fin.total_debt ?? 0) - (fin.cash ?? 0))}`],
                        ["Shares Out (M)", `${formatLargeNumber(fin.shares_outstanding ?? 0)}`],
                    ])
                },
                "Historical_CF": {
                    title: "Historical Cash Flow",
                    note: "Derived from SEC data availability",
                    table: table(["Item", "Value"], [
                        ["Operating CF", "N/A"],
                        ["Capex", "N/A"],
                        ["Free Cash Flow", "N/A"],
                    ])
                },
                "Revenue_Build": {
                    title: "Revenue Build",
                    table: table(["Year", "Revenue ($M)"], proj.years.map((y, i) => [
                        y,
                        `$${formatLargeNumber(proj.revenue[i])}`,
                    ]))
                },
                "COGS_Gross_Margin": { title: "COGS & Gross Margin", table: table(["Item", "Value"], [["Gross Margin", "N/A"]]) },
                "Opex": { title: "Operating Expenses", table: table(["Item", "Value"], [["SG&A", "N/A"], ["R&D", "N/A"]]) },
                "EBITDA_Bridge": {
                    title: "EBITDA Bridge",
                    table: table(["Year", "EBITDA ($M)"], proj.years.map((y, i) => [y, `$${formatLargeNumber(proj.ebitda[i])}`]))
                },
                "D&A": { title: "D&A", table: table(["Item", "Value"], [["D&A (% Rev)", pct(companyData?.defaults?.da_pct_revenue)]]) },
                "Capex": { title: "Capex", table: table(["Item", "Value"], [["Capex (% Rev)", pct(companyData?.defaults?.capex_pct_revenue)]]) },
                "Working_Capital": { title: "Working Capital", table: table(["Item", "Value"], [["NWC (% Rev)", "Derived from CCC"]]) },
                "Other_Operating": { title: "Other Operating", table: table(["Item", "Value"], [["Other items", "N/A"]]) },
                "Taxes": { title: "Taxes", table: table(["Item", "Value"], [["Tax Rate", pct(companyData?.defaults?.tax_rate)]]) },
                "Unlevered_FCF": {
                    title: "Unlevered Free Cash Flow",
                    table: table(["Year", "FCF ($M)"], proj.years.map((y, i) => [y, `$${formatLargeNumber(proj.fcf[i])}`]))
                },
                "Debt_Schedule": { title: "Debt Schedule", table: table(["Item", "Value"], [["Total Debt", `$${formatLargeNumber(fin.total_debt ?? 0)}`]]) },
                "Interest_Expense": { title: "Interest Expense", table: table(["Item", "Value"], [["Pre-Tax Cost of Debt", `${(result.wacc_buildup.pre_tax_cost_of_debt * 100).toFixed(2)}%`]]) },
                "Share_Count": { title: "Share Count", table: table(["Item", "Value"], [["Shares Outstanding (M)", `${formatLargeNumber(fin.shares_outstanding ?? 0)}`]]) },
                "WACC": {
                    title: "WACC Build",
                    table: table(["Component", "Value"], [
                        ["Risk-Free Rate", `${(result.wacc_buildup.risk_free_rate * 100).toFixed(2)}%`],
                        ["ERP", `${(result.wacc_buildup.equity_risk_premium * 100).toFixed(2)}%`],
                        ["Levered Beta", `${result.wacc_buildup.levered_beta.toFixed(2)}`],
                        ["WACC", `${(result.wacc_buildup.wacc * 100).toFixed(2)}%`],
                    ])
                },
                "DCF_Valuation": {
                    title: "DCF Valuation",
                    table: table(["Metric", "Value"], [
                        ["Enterprise Value (Gordon)", `$${formatLargeNumber(result.valuation.ev_gordon)}`],
                        ["Enterprise Value (Exit)", `$${formatLargeNumber(result.valuation.ev_exit)}`],
                        ["Equity Value (Gordon)", `$${formatLargeNumber(result.valuation.equity_gordon)}`],
                        ["Equity Value (Exit)", `$${formatLargeNumber(result.valuation.equity_exit)}`],
                    ])
                },
                "Terminal_Value": {
                    title: "Terminal Value",
                    table: table(["Method", "Value"], [
                        ["Gordon Growth (TV)", `$${formatLargeNumber(result.valuation.tv_gordon)}`],
                        ["Exit Multiple (TV)", `$${formatLargeNumber(result.valuation.tv_exit)}`],
                        ["PV TV (Gordon)", `$${formatLargeNumber(result.valuation.pv_tv_gordon)}`],
                        ["PV TV (Exit)", `$${formatLargeNumber(result.valuation.pv_tv_exit)}`],
                    ])
                },
                "EV_Equity_Bridge": {
                    title: "EV to Equity Bridge",
                    table: table(["Item", "Value"], [
                        ["EV (Gordon)", `$${formatLargeNumber(result.valuation.ev_gordon)}`],
                        ["Net Debt", `$${formatLargeNumber(result.valuation.net_debt)}`],
                        ["Equity Value", `$${formatLargeNumber(result.valuation.equity_gordon)}`],
                    ])
                },
                "Sensitivity": { title: "Sensitivity", table: table(["Axis", "Value"], [["WACC", "8%â€“12%"], ["Terminal Growth", "1.5%â€“3.5%"]]) },
                "Scenario_Manager": { title: "Scenario Manager", table: table(["Scenario", "Details"], [["Realistic Cable Deal", "Comcast (CMCSA) â†’ Altice USA (ATUS)"]]) },
                "KPI_Dashboard": { title: "KPI Dashboard", table: table(["KPI", "Value"], [["Implied Price (Gordon)", `$${result.valuation.price_gordon.toFixed(2)}`]]) },
                "Trading_Comps": { title: "Trading Comps", table: table(["Comps", "Value"], [["N/A", "Select comps to populate"]]) },
                "Transactions_Comps": { title: "Transactions Comps", table: table(["Deals", "Value"], [["N/A", "Select deals to populate"]]) },
                "Charts_Checks": { title: "Charts & Checks", table: table(["Check", "Status"], result.validations.map(v => [v.name, v.status.toUpperCase()])) },
            };
        }

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            event.target.classList.add('active');
        }

        function openAssumptionsModal() {
            document.getElementById('assumptions-modal').classList.remove('hidden');
        }

        function closeAssumptionsModal() {
            document.getElementById('assumptions-modal').classList.add('hidden');
        }

        // Navigation
        function goToStep(step) {
            currentStep = step;

            // Hide all steps
            document.querySelectorAll('.step-content').forEach(el => {
                el.classList.add('hidden');
            });

            // Show current step
            document.getElementById(`step${step}`).classList.remove('hidden');

            // Update indicators
            for (let i = 1; i <= 4; i++) {
                const indicator = document.getElementById(`step${i}-indicator`);
                indicator.classList.remove('active', 'completed');

                if (i < step) {
                    indicator.classList.add('completed');
                } else if (i === step) {
                    indicator.classList.add('active');
                }
            }

            if (step === 3) {
                openAssumptionsModal();
            }
        }

        function startOver() {
            selectedTicker = null;
            companyData = null;
            goToStep(1);
            document.querySelectorAll('.company-card').forEach(card => {
                card.classList.remove('selected');
            });
        }

        // Utilities
        function formatNumber(num) {
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toLocaleString('en-US', { maximumFractionDigits: 0 });
        }

        function formatLargeNumber(num) {
            // Numbers from API are in $M, so 281724 = $281.7B
            if (Math.abs(num) >= 1000000) {
                return (num / 1000000).toFixed(1) + 'T';  // Trillions
            } else if (Math.abs(num) >= 1000) {
                return (num / 1000).toFixed(1) + 'B';     // Billions
            }
            return num.toFixed(0) + 'M';                  // Millions
        }

        function avgGrowth(rates) {
            if (!rates || rates.length === 0) return 0;
            return rates.reduce((a, b) => a + b, 0) / rates.length;
        }
    </script>
</body>
</html>
